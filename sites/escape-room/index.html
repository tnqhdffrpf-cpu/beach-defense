<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Escape Room - House Exit</title>
    <style>
      :root {
        --bg: #111827;
        --panel: rgba(17, 24, 39, 0.94);
        --panel-border: #344055;
        --text: #f8fafc;
        --muted: #c8d3e1;
        --accent: #f59e0b;
        --label-bg: rgba(17, 24, 39, 0.96);
        --label-border: rgba(245, 158, 11, 0.95);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: radial-gradient(circle at 50% 0%, #243150 0%, var(--bg) 60%);
        color: var(--text);
        display: grid;
        place-items: start center;
        padding: 20px;
      }

      .app {
        width: min(1200px, 100%);
        display: grid;
        gap: 12px;
      }

      .scene {
        position: relative;
        border: 1px solid var(--panel-border);
        border-radius: 14px;
        overflow: hidden;
        background: #0b1220;
      }

      .scene img {
        width: 100%;
        display: block;
        aspect-ratio: 3 / 2;
        object-fit: cover;
      }

      .hotspot-layer {
        position: absolute;
        inset: 0;
      }

      .hotspot {
        position: absolute;
        border: 0;
        background: transparent;
        cursor: pointer;
      }

      .hotspot::after {
        content: attr(data-label);
        position: absolute;
        left: 50%;
        bottom: calc(100% + 8px);
        transform: translateX(-50%);
        opacity: 0;
        pointer-events: none;
        white-space: nowrap;
        font-size: 0.8rem;
        background: var(--label-bg);
        border: 1px solid var(--label-border);
        color: #fdf4e2;
        padding: 4px 8px;
        border-radius: 8px;
      }

      .hotspot:hover::after,
      .hotspot:focus-visible::after,
      .hotspot.active::after {
        opacity: 1;
      }

      .nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 44px;
        height: 44px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.74);
        color: #f8fafc;
        font-size: 1.25rem;
        font-weight: 700;
        cursor: pointer;
        z-index: 3;
      }

      .nav-prev { left: 10px; }
      .nav-next { right: 10px; }

      .wall-chip {
        position: absolute;
        left: 10px;
        top: 10px;
        z-index: 3;
        font-size: 0.82rem;
        background: rgba(15, 23, 42, 0.74);
        border: 1px solid rgba(255, 255, 255, 0.22);
        border-radius: 999px;
        padding: 5px 10px;
      }

      .panel {
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        background: var(--panel);
        padding: 14px;
      }

      .panel h1 {
        margin: 0;
        font-size: 1.08rem;
      }

      .panel p {
        margin: 8px 0 0;
        line-height: 1.42;
        color: var(--muted);
      }

      .panel-row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 8px;
      }

      .timer-pill {
        border: 1px solid #475569;
        border-radius: 999px;
        padding: 4px 10px;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        color: #e2e8f0;
        background: #0f172a;
      }

      .inventory {
        margin: 8px 0 0;
        padding-left: 18px;
        color: #e2ebf7;
      }

      .inventory li {
        margin: 2px 0;
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.72);
        display: grid;
        place-items: center;
        z-index: 20;
        padding: 14px;
      }

      .modal.hidden {
        display: none;
      }

      .modal-card {
        width: min(520px, 100%);
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        background: #0f172a;
        padding: 14px;
      }

      .modal-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .modal-top h2 {
        margin: 0;
        font-size: 1rem;
      }

      .close-btn,
      .mini-btn {
        border: 1px solid #475569;
        background: #1e293b;
        color: #f8fafc;
        border-radius: 8px;
        padding: 7px 10px;
        cursor: pointer;
      }

      .modal-body {
        margin-top: 10px;
        color: #cbd5e1;
        font-size: 0.95rem;
      }

      .safe-visual,
      .door-visual {
        margin-top: 8px;
        border: 1px solid #334155;
        border-radius: 10px;
        background: linear-gradient(180deg, #1f2937, #0f172a);
        padding: 12px;
      }

      .display {
        background: #0b1220;
        border: 1px solid #475569;
        border-radius: 8px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        letter-spacing: 0.18em;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        color: #e2e8f0;
      }

      .keypad {
        margin-top: 10px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      .keypad button {
        border: 1px solid #475569;
        background: #1e293b;
        color: #f8fafc;
        border-radius: 8px;
        padding: 10px;
        cursor: pointer;
        font-weight: 600;
      }

      .modal-actions {
        margin-top: 10px;
        display: flex;
        gap: 8px;
      }

      .modal-note {
        margin-top: 10px;
        color: #fde68a;
      }

      .success {
        color: #86efac;
      }

      .end-screen {
        position: fixed;
        inset: 0;
        z-index: 30;
        display: grid;
        place-items: center;
        background: rgba(2, 6, 23, 0.85);
        padding: 16px;
      }

      .end-screen.hidden {
        display: none;
      }

      .end-card {
        width: min(540px, 100%);
        border: 1px solid #475569;
        border-radius: 14px;
        background: #0f172a;
        padding: 16px;
        text-align: center;
      }

      .end-card h2 {
        margin: 0;
        font-size: 1.35rem;
      }

      .end-time {
        margin-top: 8px;
        font-size: 1.08rem;
        color: #fde68a;
      }

      strong {
        color: var(--accent);
      }
    </style>
  </head>
  <body>
    <main class="app">
      <section class="scene" aria-label="Four wall room view">
        <div id="wallChip" class="wall-chip">Gallery Wall (1 / 4)</div>
        <button id="prevBtn" class="nav-btn nav-prev" aria-label="Previous wall">&#8592;</button>
        <button id="nextBtn" class="nav-btn nav-next" aria-label="Next wall">&#8594;</button>
        <img id="sceneImage" alt="Room wall" />
        <div id="hotspotLayer" class="hotspot-layer"></div>
      </section>

      <section class="panel" aria-live="polite">
        <h1 id="title">Find a way out</h1>
        <p id="text">Someone left a blood trail at the entry. Investigate the walls, unlock the safe, then escape through the door.</p>
      </section>

      <section class="panel">
        <h1>Objective</h1>
        <p id="objectiveText">Escape the house through the front door.</p>
        <div class="panel-row">
          <button id="musicToggleBtn" class="mini-btn" type="button">Music: On</button>
          <span id="timerPill" class="timer-pill">00:00</span>
        </div>
        <ul id="inventoryList" class="inventory">
          <li>No items yet</li>
        </ul>
      </section>
    </main>

    <section id="modal" class="modal hidden" aria-modal="true" role="dialog">
      <div class="modal-card">
        <div class="modal-top">
          <h2 id="modalTitle">Inspect</h2>
          <button id="modalClose" class="close-btn" aria-label="Close">Close</button>
        </div>
        <div id="modalBody" class="modal-body"></div>
      </div>
    </section>

    <section id="endScreen" class="end-screen hidden" aria-modal="true" role="dialog">
      <div class="end-card">
        <h2>Good job. You escaped.</h2>
        <p class="end-time" id="finalTime">Time: 00:00</p>
        <p>The front door is open and you made it out safely.</p>
        <div class="panel-row" style="justify-content:center;">
          <button id="restartBtn" class="mini-btn" type="button">Play Again</button>
        </div>
      </div>
    </section>

    <script>
      const state = {
        inventory: [],
        safeUnlocked: false,
        clueNoteFound: false,
        doorKeyUsed: false,
        escaped: false,
        musicEnabled: true,
      };

      const walls = [
        {
          name: "Gallery Wall",
          image: "assets/walls/east.png",
          hotspots: [
            { id: "moonPainting", label: "Left painting", rect: "left:18%;top:15%;width:18%;height:22%;", title: "Moon Painting", text: "Two moons are visible in the scene. The torn note likely means this contributes the digit <strong>2</strong>." },
            { id: "lighthousePainting", label: "Center painting", rect: "left:39%;top:15%;width:35%;height:22%;", title: "Lighthouse Painting", text: "The numbers <strong>27 | 05</strong> are scribbled in this frame. That looks like a 4-digit safe code.", action: "safeHint" },
            { id: "lockPainting", label: "Right painting", rect: "left:76%;top:15%;width:17%;height:22%;", title: "Padlock Painting", text: "A brass lock is painted with <strong>17</strong> over <strong>37</strong>. For the torn note puzzle, use <strong>37</strong>." },
            { id: "cabinet", label: "Cabinet", rect: "left:31%;top:44%;width:38%;height:43%;", title: "Display Cabinet", text: "Storage cabinet with glass doors. Nothing moves, but it confirms this wall is mostly decorative clues." },
            { id: "books", label: "Books", rect: "left:38%;top:55%;width:14%;height:12%;", title: "Books", text: "Assorted books, mostly travel and local history." },
            { id: "plantCabinet", label: "Plant", rect: "left:53%;top:55%;width:8%;height:12%;", title: "Plant", text: "A healthy indoor plant. No hidden compartment under the pot." },
            { id: "galleryLampLeft", label: "Left lamp", rect: "left:14%;top:38%;width:14%;height:26%;", title: "Left Lamp", text: "Warm light, normal wiring." },
            { id: "galleryLampRight", label: "Right lamp", rect: "left:79%;top:38%;width:14%;height:26%;", title: "Right Lamp", text: "Matching lamp on the right pedestal." },
          ],
        },
        {
          name: "Lounge Wall",
          image: "assets/walls/west.png",
          hotspots: [
            { id: "wallClock", label: "Wall clock", rect: "left:12%;top:9%;width:17%;height:23%;", title: "Wall Clock", text: "The clock is running. Not directly useful yet, but likely part of atmosphere." },
            { id: "loungeSofa", label: "Sofa", rect: "left:12%;top:40%;width:60%;height:30%;", title: "Sofa", text: "Comfortable but ordinary. No key tucked in the seams." },
            { id: "coffeeTable", label: "Coffee table", rect: "left:13%;top:67%;width:49%;height:20%;", title: "Coffee Table", text: "Coffee ring marks and dust, nothing removable." },
            { id: "mug", label: "Mug", rect: "left:24%;top:58%;width:8%;height:14%;", title: "Mug", text: "Still warm. Whoever left was here recently." },
            { id: "safe", label: "Safe drawer", rect: "left:77%;top:56%;width:12%;height:20%;", title: "Safe Drawer", text: "A keypad safe is set into the side table. Click to zoom in and try a code.", action: "openSafe" },
            { id: "loungeLamp", label: "Lamp", rect: "left:75%;top:31%;width:14%;height:24%;", title: "Lamp", text: "Lamp hums faintly. No hidden switch." },
            { id: "roach", label: "Cockroach", rect: "left:86%;top:86%;width:7%;height:10%;", title: "Cockroach", text: "A cockroach darts near the wall. Gross, but not relevant to escape." },
          ],
        },
        {
          name: "Entry Wall",
          image: "assets/walls/south.png",
          hotspots: [
            { id: "entryWindow", label: "Window", rect: "left:10%;top:18%;width:21%;height:46%;", title: "Window", text: "Outside visibility is poor; the frame is sealed shut." },
            { id: "door", label: "Door", rect: "left:43%;top:12%;width:25%;height:64%;", title: "Front Door", text: "The only way out. It has an electronic lock and a key cylinder. Click to zoom in.", action: "openDoor" },
            { id: "welcomeMat", label: "Welcome mat", rect: "left:43%;top:74%;width:25%;height:11%;", title: "Welcome Mat", text: "The mat says WELCOME. No key under it." },
            { id: "bloodTrail", label: "Blood trail", rect: "left:57%;top:80%;width:41%;height:18%;", title: "Blood Trail", text: "The blood trail starts near the mat and drags back into the house. Someone escaped in a hurry." },
            { id: "plantLeft", label: "Left plant", rect: "left:29%;top:50%;width:18%;height:30%;", title: "Left Plant", text: "Soil is undisturbed." },
            { id: "plantRight", label: "Right plant", rect: "left:69%;top:50%;width:18%;height:30%;", title: "Right Plant", text: "Identical to the left plant." },
          ],
        },
        {
          name: "Family Wall",
          image: "assets/walls/north.png",
          hotspots: [
            { id: "familyWindow", label: "Window", rect: "left:8%;top:15%;width:24%;height:44%;", title: "Window", text: "Night view outside. No obvious clue written on glass." },
            { id: "flowerPainting", label: "Flower painting", rect: "left:40%;top:15%;width:28%;height:20%;", title: "Flower Painting", text: "Exactly <strong>4</strong> red flowers stand out in the bouquet. That seems intentional." },
            { id: "familyPhoto", label: "Family photo", rect: "left:69%;top:15%;width:25%;height:20%;", title: "Family Photo", text: "On the frame edge is a faint pencil note: <strong>FLOWER -> MOON -> LOCK</strong>." },
            { id: "familyCouch", label: "Couch", rect: "left:43%;top:52%;width:42%;height:29%;", title: "Couch", text: "Three-seat brown couch with worn armrests." },
            { id: "tableLeft", label: "Left side table", rect: "left:34.5%;top:60%;width:8%;height:22%;", title: "Left Side Table", text: "Small side table with one drawer." },
            { id: "tableRight", label: "Right side table", rect: "left:86%;top:60%;width:10%;height:22%;", title: "Right Side Table", text: "Matching table on the right side." },
            { id: "familyLampLeft", label: "Left lamp", rect: "left:37%;top:41%;width:8%;height:19%;", title: "Left Lamp", text: "Left lamp glows softly." },
            { id: "familyLampRight", label: "Right lamp", rect: "left:86%;top:42%;width:8%;height:18%;", title: "Right Lamp", text: "Right lamp uses the same warm bulb tone." },
            { id: "greenPillow", label: "Green pillow", rect: "left:47%;top:56%;width:8%;height:16%;", title: "Green Pillow", text: "Soft green accent pillow." },
            { id: "darkPillow", label: "Dark pillow", rect: "left:76%;top:56%;width:8%;height:16%;", title: "Dark Pillow", text: "Dark accent pillow with rough fabric." },
          ],
        },
      ];

      const SAFE_CODE = "2705";
      const DOOR_CODE = "4237";
      const SAFE_OPEN_SFX = "https://commons.wikimedia.org/wiki/Special:FilePath/Door_handle_creaking.ogg";
      const DOOR_OPEN_SFX = "https://commons.wikimedia.org/wiki/Special:FilePath/Squeaky_door_hinge.ogg";

      const titleEl = document.getElementById("title");
      const textEl = document.getElementById("text");
      const objectiveTextEl = document.getElementById("objectiveText");
      const inventoryListEl = document.getElementById("inventoryList");
      const timerPillEl = document.getElementById("timerPill");
      const musicToggleBtnEl = document.getElementById("musicToggleBtn");
      const wallChipEl = document.getElementById("wallChip");
      const imageEl = document.getElementById("sceneImage");
      const hotspotLayerEl = document.getElementById("hotspotLayer");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const modalEl = document.getElementById("modal");
      const modalTitleEl = document.getElementById("modalTitle");
      const modalBodyEl = document.getElementById("modalBody");
      const modalCloseEl = document.getElementById("modalClose");
      const endScreenEl = document.getElementById("endScreen");
      const finalTimeEl = document.getElementById("finalTime");
      const restartBtnEl = document.getElementById("restartBtn");

      let currentWall = 0;
      let startedAt = Date.now();
      let timerInterval = null;
      let audioCtx = null;
      let ambientNodes = null;

      const sfx = {
        safeOpen: new Audio(SAFE_OPEN_SFX),
        doorOpen: new Audio(DOOR_OPEN_SFX),
      };

      sfx.safeOpen.preload = "auto";
      sfx.doorOpen.preload = "auto";
      sfx.safeOpen.volume = 0.65;
      sfx.doorOpen.volume = 0.72;

      function formatTime(ms) {
        const total = Math.max(0, Math.floor(ms / 1000));
        const minutes = String(Math.floor(total / 60)).padStart(2, "0");
        const seconds = String(total % 60).padStart(2, "0");
        return `${minutes}:${seconds}`;
      }

      function updateTimer() {
        timerPillEl.textContent = formatTime(Date.now() - startedAt);
      }

      function playSfx(kind) {
        const clip = sfx[kind];
        if (!clip) return;
        try {
          clip.currentTime = 0;
          const maybe = clip.play();
          if (maybe && typeof maybe.catch === "function") {
            maybe.catch(() => {});
          }
        } catch (_) {
          // Ignore audio policy errors.
        }
      }

      function ensureAudioContext() {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === "suspended") {
          audioCtx.resume();
        }
      }

      function startAmbientMusic() {
        if (ambientNodes || !state.musicEnabled) return;
        ensureAudioContext();
        if (!audioCtx) return;

        const master = audioCtx.createGain();
        master.gain.value = 0.02;
        master.connect(audioCtx.destination);

        const oscA = audioCtx.createOscillator();
        oscA.type = "sine";
        oscA.frequency.value = 196;
        const gainA = audioCtx.createGain();
        gainA.gain.value = 0.3;
        oscA.connect(gainA);
        gainA.connect(master);

        const oscB = audioCtx.createOscillator();
        oscB.type = "triangle";
        oscB.frequency.value = 261.63;
        const gainB = audioCtx.createGain();
        gainB.gain.value = 0.12;
        oscB.connect(gainB);
        gainB.connect(master);

        const lfo = audioCtx.createOscillator();
        lfo.type = "sine";
        lfo.frequency.value = 0.08;
        const lfoGain = audioCtx.createGain();
        lfoGain.gain.value = 0.015;
        lfo.connect(lfoGain);
        lfoGain.connect(master.gain);

        oscA.start();
        oscB.start();
        lfo.start();

        ambientNodes = { master, oscA, oscB, lfo, gainA, gainB, lfoGain };
      }

      function stopAmbientMusic() {
        if (!ambientNodes) return;
        const { oscA, oscB, lfo, master } = ambientNodes;
        const now = audioCtx ? audioCtx.currentTime : 0;
        if (master && audioCtx) {
          master.gain.cancelScheduledValues(now);
          master.gain.linearRampToValueAtTime(0.0001, now + 0.25);
        }
        setTimeout(() => {
          try { oscA.stop(); } catch (_) {}
          try { oscB.stop(); } catch (_) {}
          try { lfo.stop(); } catch (_) {}
          ambientNodes = null;
        }, 300);
      }

      function armAudio() {
        ensureAudioContext();
        if (state.musicEnabled) {
          startAmbientMusic();
        }
      }

      function finishGame() {
        if (state.escaped) return;
        state.escaped = true;
        if (timerInterval) {
          window.clearInterval(timerInterval);
          timerInterval = null;
        }
        addInventory("House Keyring (Exit)");
        objectiveTextEl.textContent = "Escaped.";
        titleEl.textContent = "You Escaped";
        textEl.textContent = "The lock clicks, the door opens, and you step out before whoever left that blood trail returns.";
        finalTimeEl.textContent = `Time: ${formatTime(Date.now() - startedAt)}`;
        stopAmbientMusic();
        endScreenEl.classList.remove("hidden");
      }

      function addInventory(item) {
        if (!state.inventory.includes(item)) {
          state.inventory.push(item);
          renderInventory();
        }
      }

      function renderInventory() {
        if (state.inventory.length === 0) {
          inventoryListEl.innerHTML = "<li>No items yet</li>";
          return;
        }

        inventoryListEl.innerHTML = state.inventory.map((item) => `<li>${item}</li>`).join("");
      }

      function openModal(title, html) {
        modalTitleEl.textContent = title;
        modalBodyEl.innerHTML = html;
        modalEl.classList.remove("hidden");
      }

      function closeModal() {
        modalEl.classList.add("hidden");
      }

      function openSafeModal() {
        const html = `
          <p>Steel keypad safe. Enter the 4-digit code.</p>
          <div class="safe-visual">
            <div id="safeDisplay" class="display">----</div>
            <div class="keypad" id="safeKeypad"></div>
            <div class="modal-actions">
              <button class="mini-btn" id="safeClear">Clear</button>
              <button class="mini-btn" id="safeEnter">Enter</button>
            </div>
            <div id="safeMsg" class="modal-note"></div>
          </div>
        `;

        openModal("Safe Keypad", html);

        let input = "";
        const displayEl = document.getElementById("safeDisplay");
        const keypadEl = document.getElementById("safeKeypad");
        const msgEl = document.getElementById("safeMsg");

        if (state.safeUnlocked) {
          msgEl.innerHTML = "<span class='success'>Safe already opened. You took the Silver Key and torn note.</span>";
        }

        function refreshDisplay() {
          const masked = input.padEnd(4, "-");
          displayEl.textContent = masked;
        }

        for (let i = 1; i <= 9; i += 1) {
          const btn = document.createElement("button");
          btn.textContent = String(i);
          btn.addEventListener("click", () => {
            if (input.length < 4) input += String(i);
            refreshDisplay();
          });
          keypadEl.appendChild(btn);
        }

        const zeroBtn = document.createElement("button");
        zeroBtn.textContent = "0";
        zeroBtn.style.gridColumn = "2";
        zeroBtn.addEventListener("click", () => {
          if (input.length < 4) input += "0";
          refreshDisplay();
        });
        keypadEl.appendChild(zeroBtn);

        document.getElementById("safeClear").addEventListener("click", () => {
          input = "";
          msgEl.textContent = "";
          refreshDisplay();
        });

        document.getElementById("safeEnter").addEventListener("click", () => {
          if (input === SAFE_CODE) {
            if (!state.safeUnlocked) {
              state.safeUnlocked = true;
              state.clueNoteFound = true;
              addInventory("Silver Key");
              addInventory("Torn Note: FLOWER -> MOON -> LOCK");
              objectiveTextEl.textContent = "Use clues to derive the door code, then unlock and open the front door.";
              playSfx("safeOpen");
            }
            msgEl.innerHTML = "<span class='success'>Safe unlocked. Inside: Silver Key and a torn note that reads FLOWER -> MOON -> LOCK.</span>";
          } else {
            msgEl.textContent = "Incorrect code.";
          }
        });

        refreshDisplay();
      }

      function openDoorModal() {
        const hasKey = state.inventory.includes("Silver Key");
        const html = `
          <p>The front door needs both a key and a 4-digit code.</p>
          <div class="door-visual">
            <div id="doorDisplay" class="display">----</div>
            <div class="modal-actions">
              <button class="mini-btn" id="useKeyBtn">${state.doorKeyUsed ? "Key Inserted" : "Use Silver Key"}</button>
              <button class="mini-btn" id="doorClear">Clear</button>
              <button class="mini-btn" id="doorEnter">Unlock</button>
            </div>
            <div class="keypad" id="doorKeypad"></div>
            <div id="doorMsg" class="modal-note">${hasKey ? "" : "You still need a key from the safe."}</div>
          </div>
        `;

        openModal("Door Lock", html);

        let input = "";
        const displayEl = document.getElementById("doorDisplay");
        const keypadEl = document.getElementById("doorKeypad");
        const msgEl = document.getElementById("doorMsg");
        const useKeyBtn = document.getElementById("useKeyBtn");

        function refreshDisplay() {
          displayEl.textContent = input.padEnd(4, "-");
        }

        for (let i = 1; i <= 9; i += 1) {
          const btn = document.createElement("button");
          btn.textContent = String(i);
          btn.addEventListener("click", () => {
            if (input.length < 4) input += String(i);
            refreshDisplay();
          });
          keypadEl.appendChild(btn);
        }

        const zeroBtn = document.createElement("button");
        zeroBtn.textContent = "0";
        zeroBtn.style.gridColumn = "2";
        zeroBtn.addEventListener("click", () => {
          if (input.length < 4) input += "0";
          refreshDisplay();
        });
        keypadEl.appendChild(zeroBtn);

        useKeyBtn.addEventListener("click", () => {
          if (!hasKey) {
            msgEl.textContent = "No key available.";
            return;
          }
          state.doorKeyUsed = true;
          useKeyBtn.textContent = "Key Inserted";
          msgEl.textContent = "Key inserted. Now enter the 4-digit code.";
        });

        document.getElementById("doorClear").addEventListener("click", () => {
          input = "";
          msgEl.textContent = "";
          refreshDisplay();
        });

        document.getElementById("doorEnter").addEventListener("click", () => {
          if (!state.doorKeyUsed) {
            msgEl.textContent = "Insert the Silver Key first.";
            return;
          }
          if (input !== DOOR_CODE) {
            msgEl.textContent = "Wrong code.";
            return;
          }
          playSfx("doorOpen");
          msgEl.innerHTML = "<span class='success'>Door unlocked. Escape successful.</span>";
          finishGame();
        });

        refreshDisplay();
      }

      function handleHotspotAction(item) {
        if (item.action === "openSafe") {
          openSafeModal();
          return;
        }

        if (item.action === "openDoor") {
          openDoorModal();
          return;
        }

        if (item.action === "safeHint") {
          openModal("Painting Detail", "<p>Zoomed frame detail: <strong>27 | 05</strong> scratched near the lighthouse. It looks deliberate.</p>");
        }
      }

      function buildHotspots(wall) {
        hotspotLayerEl.innerHTML = "";

        wall.hotspots.forEach((item) => {
          const button = document.createElement("button");
          button.className = "hotspot";
          button.setAttribute("style", item.rect);
          button.dataset.label = item.label;
          button.setAttribute("aria-label", `Inspect ${item.label}`);

          button.addEventListener("click", () => {
            hotspotLayerEl.querySelectorAll(".hotspot").forEach((el) => el.classList.remove("active"));
            button.classList.add("active");
            titleEl.textContent = item.title;
            textEl.innerHTML = item.text;
            handleHotspotAction(item);
          });

          hotspotLayerEl.appendChild(button);
        });
      }

      function renderWall(index) {
        const wall = walls[index];
        imageEl.src = wall.image;
        imageEl.alt = `${wall.name} room view`;
        wallChipEl.textContent = `${wall.name} (${index + 1} / ${walls.length})`;
        buildHotspots(wall);
      }

      function stepWall(step) {
        currentWall = (currentWall + step + walls.length) % walls.length;
        renderWall(currentWall);
      }

      prevBtn.addEventListener("click", () => stepWall(-1));
      nextBtn.addEventListener("click", () => stepWall(1));
      modalCloseEl.addEventListener("click", closeModal);
      restartBtnEl.addEventListener("click", () => window.location.reload());
      musicToggleBtnEl.addEventListener("click", () => {
        state.musicEnabled = !state.musicEnabled;
        musicToggleBtnEl.textContent = state.musicEnabled ? "Music: On" : "Music: Off";
        if (state.musicEnabled) {
          startAmbientMusic();
        } else {
          stopAmbientMusic();
        }
      });
      modalEl.addEventListener("click", (event) => {
        if (event.target === modalEl) closeModal();
      });
      window.addEventListener("pointerdown", armAudio, { once: true });

      window.addEventListener("keydown", (event) => {
        if (event.key === "ArrowLeft") stepWall(-1);
        if (event.key === "ArrowRight") stepWall(1);
        if (event.key === "Escape") closeModal();
      });

      renderInventory();
      updateTimer();
      timerInterval = window.setInterval(updateTimer, 1000);
      renderWall(currentWall);
    </script>
  </body>
</html>
